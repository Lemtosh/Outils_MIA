<!DOCTYPE html>

<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Outil de validation</title>
<style>
    :root{
      --bg: #ffffff;
      --text: #111;
      --muted: #666;
      --card: #ffffff;
      --border: #ddd;
      --border2: #eee;
      --tableBorder: #ccc;
      --btnDanger: #ff4444;
      --btnDangerHover: #cc0000;
      --canvasBorder: #eee;
      --updateBg: #ffdddd;
      --updateText: #a00;
      --updateBorder: #a00;
      --link: #0b3d91;

      /* Frise (clair = couleurs d'origine) */
      --timelineRed: #d32f2f;
      --timelineGreen: #2e7d32;

      /* Texte "bonus" */
      --bonusText: rgba(0,0,0,0.60);
      --bonusTextStroke: rgba(255,255,255,0.70);
      --bonusTextDark: rgba(255,255,255,0.92);
      --bonusTextStrokeDark: rgba(0,0,0,0.40);

      --markerBlue: #0b3d91;
    }
    body.dark{
      --bg: #0f1216;
      --text: #e8eaed;
      --muted: #a6adb7;
      --card: #161b22;
      --border: #2b313a;
      --border2: #232a33;
      --tableBorder: #2b313a;
      --btnDanger: #d63a3a;
      --btnDangerHover: #b02b2b;
      --canvasBorder: #2b313a;
      --updateBg: #3a1b1b;
      --updateText: #ffb4b4;
      --updateBorder: #a64a4a;
      --link: #8ab4f8;

      /* Frise (sombre = pastel) */
      --timelineRed: #FF746C;
      --timelineGreen: #80EF80;

      --markerBlue: #8ab4f8;
    }

    html, body { height: 100%; margin: 0; }
    body { font-family: Arial, sans-serif; overflow: hidden; background: var(--bg); color: var(--text); }
    * { box-sizing: border-box; }

    .app{
      height: 100vh;
      display: flex;
      gap: 14px;
      padding: 14px;
      align-items: stretch;
      overflow: auto;
    }
    .left{
      flex: 1 1 680px;
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .right{
      flex: 0 1 420px;
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 10px;
      border-left: 1px solid var(--border);
      padding-left: 14px;
      position: relative;
    }

    h1 { font-size: 18px; margin: 0; }
    h2 { font-size: 14px; margin: 0; }
    .titleAccent{ color:#e41c7a; }

    .row { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
    label { font-size: 12px; }

    input[type="text"] { width: 98px; text-align: center; padding: 3px 4px; background: var(--card); color: var(--text); border: 1px solid var(--tableBorder); border-radius: 6px; }
    input[type="checkbox"] { transform: translateY(1px); }

    .tableScroll{
      width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      border: 1px solid var(--border2);
      border-radius: 6px;
      background: var(--card);
    }

    table { width: max-content; min-width: 100%; border-collapse: collapse; table-layout: fixed; }
    th, td { border: 1px solid var(--tableBorder); padding: 3px 4px; text-align: center; font-size: 12px; }

    .tableStyled th{
      background-color:#414141;
      color:#ffffff;
    }

    td:nth-child(1), th:nth-child(1) { width: 26px; }
    td:nth-child(2), th:nth-child(2) { width: 70px; }
    td:nth-child(5), th:nth-child(5) { width: 54px; }
    td:nth-child(6), th:nth-child(6) { width: 86px; }

    select { width: 100%; max-width: 100%; font-size: 12px; padding: 2px 2px; margin: 0; display: block; background: var(--card); color: var(--text); border: 1px solid var(--tableBorder); border-radius: 6px; }
    .crmInput { width: 100%; max-width: 100%; padding: 2px 3px; text-align: center; display: block; background: var(--card); color: var(--text); border: 1px solid var(--tableBorder); border-radius: 6px; }

    .result { font-weight: bold; font-size: 13px; }
    .muted { font-size: 12px; color: var(--muted); }
    .error { color: #ff6b6b; font-size: 12px; white-space: pre-line; }

    button { padding: 7px 12px; cursor: pointer; font-size: 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--card); color: var(--text); }
    #btnClear { background-color: var(--btnDanger); color: white; border: none; }
    #btnClear:hover { background-color: var(--btnDangerHover); }

    .card { border: 1px solid var(--border); border-radius: 8px; padding: 10px; background: var(--card); }
    canvas { width: 100%; height: 136px; border: 1px solid var(--canvasBorder); border-radius: 6px; display: block; background: var(--card); }

    .cardSmall { padding: 10px; }

    .interruptions {
      margin-top: 8px;
      font-size: 12px;
      color: #ff8d8d;
      line-height: 1.25;
      max-height: 88px;
      overflow: auto;
      border-top: 1px dashed var(--border2);
      padding-top: 6px;
      white-space: pre-line;
    }
    .interruptionsTitle { font-weight: bold; margin-bottom: 2px; }

    #updateBanner{
      display:none;
      background: var(--updateBg);
      color: var(--updateText);
      padding:8px 10px;
      border:1px solid var(--updateBorder);
      border-radius:8px;
      font-size:12px;
      line-height:1.25;
    }
    #updateBanner a{ color: var(--link); font-weight:bold; text-decoration: underline; }

    #crmTableWrap{ display:none; margin-top: 10px; }
    #crmTableWrap table{ width: 100%; min-width: 0; table-layout: auto; }
    #crmTableWrap th, #crmTableWrap td{ font-size: 12px; padding: 5px 6px; }

    #crmToolWrap{ display:none; margin-top: 10px; }
    #crmPermitWrap{ display:none; margin-top: 10px; }

    .notesBox{ display:flex; flex-direction:column; }
    .notesBox textarea{
      flex: 1;
      min-height: 84px;
      resize: vertical;
      font-size: 12px;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--text);
      outline: none;
    }

    .crmTrail{
      margin-top: 6px;
      padding-top: 6px;
      border-top: 1px dashed var(--border2);
      font-size: 12px;
      color: var(--muted);
      white-space: pre-line;
    }
    .crmTrail strong{ color: var(--text); }

    /* Meta auteur */
    .metaWrap{ margin-top: auto; display:flex; justify-content:flex-end; }
    .metaBtn{
      font-size: 11px; color: var(--muted);
      background: color-mix(in oklab, var(--card) 85%, transparent);
      border: 1px solid var(--border2);
      padding: 6px 10px; border-radius: 10px;
      cursor: pointer; user-select: none;
    }
    .metaBtn:hover{ color: var(--text); }
    .metaPanel{
      display:none; margin-top: 8px;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px;
      padding-bottom: 64px; /* √©vite superposition avec le bouton th√®me */
      background: var(--card);
      color: var(--text);
      font-size: 12px;
      line-height: 1.35;
      position: relative;
      z-index: 10001;
    }
    .metaPanel .mutedLine{ color: var(--muted); font-size: 11px; }
    .themeFab{ z-index: 9999; }

    @media (max-width: 520px){
      .metaPanel{ padding-bottom: 52px; }
    }

    @media (max-width: 1100px){
      body { overflow: auto; }
      .app { flex-direction: column; }
      .right { border-left: none; padding-left: 0; }
    }

    #periodsTable input[type="text"]{ width: 100%; box-sizing: border-box; }

    /* Bouton th√®me */
    .themeFab{
      position: fixed;
      bottom: 12px;
      left: 12px;
      width: 40px;
      height: 40px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--text);
      box-shadow: 0 6px 18px rgba(0,0,0,0.12);
    }
    .themeFab:hover{ filter: brightness(0.98); }
    #themeIcon{ font-size: 17px; line-height: 1; }
    @media (max-width: 520px){
      .themeFab{ width: 32px; height: 32px; bottom: 8px; left: 8px; }
      #themeIcon{ font-size: 14px; }
    }

    /* Info-bulle Indicatif frise */
    .thInfoWrap{ display:inline-flex; align-items:center; justify-content:center; gap:6px; }
    .infoBtn{
      width: 18px; height: 18px; min-width: 18px; min-height: 18px;
      padding: 0; border-radius: 50%;
      font-size: 12px; line-height: 18px;
      text-align:center;
      border: 1px solid var(--border);
      background: color-mix(in oklab, var(--card) 92%, transparent);
      color: var(--muted);
      cursor: pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    .infoBtn:hover{ color: var(--text); }

    .tooltip{
      position: fixed;
      display:none;
      max-width: 280px;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--text);
      box-shadow: 0 10px 26px rgba(0,0,0,0.20);
      font-size: 12px;
      line-height: 1.25;
      z-index: 10000;
    }
  

    /* ===== Boutons outils : couleur uniquement (pas de grossissement) ===== */
    #btnCrmTable.toolBtnActive,
    #btnCrmTool.toolBtnActive,
    #btnCrmPermit.toolBtnActive{
      background: #e41c7a !important;
      border-color: #e41c7a !important;
      color: #ffffff !important;
      box-shadow: none !important;
      transform: none !important;
      filter: none !important;
    }

    /* Neutralise tout effet de pression/focus (transform/ombre) sur ces 3 boutons */
    #btnCrmTable:active, #btnCrmTool:active, #btnCrmPermit:active,
    #btnCrmTable:focus,  #btnCrmTool:focus,  #btnCrmPermit:focus,
    #btnCrmTable:focus-visible, #btnCrmTool:focus-visible, #btnCrmPermit:focus-visible{
      transform: none !important;
      box-shadow: none !important;
    }

  

/* === Modern grey UI patch (Apple-like) + one-page + dark readability fixes === */
:root{
  --accent: #11a9a6;
  --accent2: #0f8f8c;
  --pageBg1: #f4f5f7;
  --pageBg2: #ffffff;
  --cardBg: rgba(255,255,255,0.92);
  --cardStroke: rgba(17, 24, 39, 0.10);
  --softStroke: rgba(17, 24, 39, 0.08);
  --shadowA: 0 10px 30px rgba(17,24,39,0.10);
  --shadowB: 0 6px 18px rgba(17,24,39,0.08);
  --radiusXL: 22px;
  --radiusL: 18px;
  --radiusM: 14px;
  --glow: 0 0 0 4px color-mix(in oklab, var(--accent) 20%, transparent);
}

body.dark{
  --pageBg1: #0b0d10;
  --pageBg2: #0f1216;
  --cardBg: rgba(20, 23, 28, 0.92);
  --cardStroke: rgba(255,255,255,0.14);
  --softStroke: rgba(255,255,255,0.16);
  --shadowA: 0 16px 44px rgba(0,0,0,0.50);
  --shadowB: 0 10px 26px rgba(0,0,0,0.36);
  --glow: 0 0 0 4px rgba(17,169,166,0.18);
}

body{
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  background: radial-gradient(900px 520px at 18% 0%, rgba(17,169,166,0.08), transparent 60%),
              linear-gradient(180deg, var(--pageBg1), var(--pageBg2));
  overflow: auto;
}

body.dark{
  background: radial-gradient(900px 520px at 18% 0%, rgba(17,169,166,0.12), transparent 60%),
              linear-gradient(180deg, var(--pageBg1), var(--pageBg2));
}

.app{
  height: auto;
  min-height: 100vh;
  max-width: 1320px;
  margin: 0 auto;
  padding: 42px 22px 78px;
  gap: 18px;
  align-items: flex-start;
}

.left{ gap: 14px; }
.right{ gap: 14px; border-left: none; padding-left: 0; }

.headerRow{
  width: 100%;
  justify-content: center !important;
  align-items: center !important;
  flex-direction: column;
  gap: 18px !important;
  padding: 6px 0 10px;
}

.headerBtns{ justify-content: center; }

h1{
  font-size: clamp(28px, 4vw, 54px);
  letter-spacing: -0.8px;
  line-height: 1.05;
  color: color-mix(in oklab, var(--text) 94%, #000);
}

body.dark h1{ color: var(--text); }

.titleAccent{
  font-size: 14px;
  font-weight: 600;
  padding: 7px 12px;
  border-radius: 999px;
  margin-left: 10px;
  color: color-mix(in oklab, var(--text) 85%, #000);
  background: color-mix(in oklab, var(--card) 84%, transparent);
  border: 1px solid var(--softStroke);
}

body.dark .titleAccent{ color: rgba(255,255,255,0.88); background: rgba(255,255,255,0.06); }

.card{
  border: 1px solid var(--cardStroke);
  border-radius: var(--radiusXL);
  background: var(--cardBg);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  box-shadow: var(--shadowA);
  padding: 16px;
}

.cardSmall{ border-radius: var(--radiusL); box-shadow: var(--shadowB); }

/* --- Clickable hover glow (except text fields/textarea) --- */
button,
.infoBtn,
.metaBtn,
.themeFab,
.typeSwitchToggle,
.motoBtn{
  transition: filter 120ms ease, box-shadow 120ms ease, border-color 120ms ease, background-color 120ms ease;
}

button:hover,
.infoBtn:hover,
.metaBtn:hover,
.themeFab:hover,
.typeSwitchToggle:hover,
.motoBtn:hover{
  filter: brightness(1.04);
  box-shadow: var(--shadowB), var(--glow);
  border-color: color-mix(in oklab, var(--accent) 30%, var(--softStroke));
}

button{
  border-radius: 999px;
  border: 1px solid var(--softStroke);
  background: rgba(255,255,255,0.70);
  padding: 10px 18px;
  font-size: 14px;
  font-weight: 600;
  letter-spacing: -0.1px;
  box-shadow: 0 1px 0 rgba(17,24,39,0.06);
}

body.dark button{ background: rgba(255,255,255,0.06); border-color: rgba(255,255,255,0.16); color: rgba(255,255,255,0.92); }

#btnCrmTable.toolBtnActive,
#btnCrmTool.toolBtnActive,
#btnCrmPermit.toolBtnActive{
  background: var(--accent) !important;
  border-color: var(--accent) !important;
  color: #fff !important;
  box-shadow: 0 10px 22px rgba(17,169,166,0.20) !important;
}

#btnCrmTable:active,
#btnCrmTool:active,
#btnCrmPermit:active{ transform: none !important; }

.btnClear{ background: #ff3b30; border: none; padding: 10px 16px; font-weight: 700; }

/* Inputs (no hover glow here; only focus) */
input[type="text"], select, textarea{
  border-radius: 16px;
  border: 1px solid var(--softStroke);
  background: rgba(255,255,255,0.72);
  color: var(--text);
  box-shadow: inset 0 1px 0 rgba(17,24,39,0.04);
}

body.dark input[type="text"], body.dark select, body.dark textarea{ background: rgba(255,255,255,0.06); border-color: rgba(255,255,255,0.16); color: rgba(255,255,255,0.92); }

body.dark input[type="text"]::placeholder, body.dark textarea::placeholder{ color: rgba(255,255,255,0.55); }

input[type="text"]:focus, select:focus, textarea:focus{ outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px color-mix(in oklab, var(--accent) 26%, transparent); }

label{ font-size: 12px; font-weight: 600; color: color-mix(in oklab, var(--text) 75%, transparent); }
body.dark label{ color: rgba(255,255,255,0.76); }

.muted{ color: color-mix(in oklab, var(--text) 55%, transparent); }
body.dark .muted{ color: rgba(255,255,255,0.70); }

.tableScroll{ border-radius: var(--radiusL); border: 1px solid var(--softStroke); background: rgba(255,255,255,0.66); box-shadow: var(--shadowB); }
body.dark .tableScroll{ background: rgba(255,255,255,0.03); }

.tableStyled th{ background: rgba(243,244,246,0.98); color: color-mix(in oklab, var(--text) 88%, #000); font-weight: 700; letter-spacing: 0.1px; }
body.dark .tableStyled th{ background: rgba(22, 27, 34, 0.98); color: rgba(255,255,255,0.92); }
body.dark .tableStyled td{ color: rgba(255,255,255,0.88); }

canvas{ border-radius: var(--radiusL); border: 1px solid var(--softStroke); background: rgba(255,255,255,0.72); }
body.dark canvas{ background: rgba(255,255,255,0.04); }

body.dark .interruptions{ border-top-color: rgba(255,255,255,0.14); background: rgba(255,255,255,0.04); color: rgba(255,255,255,0.78); padding: 8px 10px; border-radius: 12px; }

/* === Moto button (checkbox hidden, label looks like tool button) === */
.motoToggleRow{ display: flex; align-items: center; gap: 10px; }
#moto{ position: absolute; opacity: 0; pointer-events: none; }

.motoBtn{
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-width: 86px;
  padding: 10px 16px;
  border-radius: 999px;
  border: 1px solid var(--softStroke);
  background: rgba(255,255,255,0.70);
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
  letter-spacing: -0.1px;
}

body.dark .motoBtn{ background: rgba(255,255,255,0.06); border-color: rgba(255,255,255,0.16); color: rgba(255,255,255,0.92); }

#moto:checked + .motoBtn{
  background: rgba(17,169,166,0.16);
  border-color: rgba(17,169,166,0.55);
}

/* === Type switch: click anywhere to toggle Auto <-> Moto === */
.typeSelectHidden{ position: absolute !important; opacity: 0 !important; pointer-events: none !important; width: 1px !important; height: 1px !important; overflow: hidden !important; }

.tableStyled th:nth-child(2),
.tableStyled td:nth-child(2){ width: 150px !important; }

.typeSwitchToggle{
  position: relative;
  display: grid;
  grid-template-columns: 1fr 1fr;
  align-items: center;
  width: 132px;
  min-width: 132px;
  height: 30px;
  padding: 2px;
  border-radius: 999px;
  border: 1px solid var(--softStroke);
  background: rgba(255,255,255,0.55);
  box-shadow: inset 0 1px 0 rgba(17,24,39,0.05);
  user-select: none;
  cursor: pointer;
}

body.dark .typeSwitchToggle{ background: rgba(255,255,255,0.06); border-color: rgba(255,255,255,0.16); }

.typeSwitchToggle .typeText{
  position: relative;
  z-index: 1;
  text-align: center;
  font-size: 12px;
  font-weight: 700;
  letter-spacing: -0.1px;
  pointer-events: none; /* click anywhere toggles */
  color: rgba(17,24,39,0.72);
}

body.dark .typeSwitchToggle .typeText{ color: rgba(255,255,255,0.72); }

.typeSwitchToggle .typePill{
  position: absolute;
  top: 2px;
  bottom: 2px;
  left: 2px;
  width: calc(50% - 2px);
  border-radius: 999px;
  background: rgba(255,255,255,0.92);
  box-shadow: 0 6px 16px rgba(17,24,39,0.12);
  transition: transform 160ms ease, background 160ms ease;
}

body.dark .typeSwitchToggle .typePill{ background: rgba(255,255,255,0.14); box-shadow: 0 10px 22px rgba(0,0,0,0.35); }

.typeSwitchToggle.isMoto .typePill{ transform: translateX(100%); }

.typeSwitchToggle.isMoto .typeTextMoto,
.typeSwitchToggle:not(.isMoto) .typeTextAuto{ color: rgba(17,24,39,0.92); }

body.dark .typeSwitchToggle.isMoto .typeTextMoto,
body.dark .typeSwitchToggle:not(.isMoto) .typeTextAuto{ color: rgba(255,255,255,0.92); }

/* === One-page layout (desktop) === */
@media (min-width: 1200px) and (min-height: 760px){
  html, body{ height: 100%; }
  body{ overflow: hidden; }
  .app{ height: 100vh; overflow-y: auto; overflow-x: hidden; padding: 18px 16px 18px; gap: 14px; }
  .left, .right{ gap: 12px; }
  h1{ font-size: clamp(26px, 3.3vw, 44px); }
  .card{ padding: 12px 14px; }
  .cardSmall{ padding: 12px 14px; }
  button{ padding: 9px 14px; font-size: 13px; }
  input[type="text"], select{ padding: 8px 10px; font-size: 12px; }
  th, td{ padding: 6px 8px; }
  .tableStyled th, .tableStyled td{ font-size: 11px; }
  canvas{ height: 120px; }
  .interruptions{ max-height: 62px; margin-top: 6px; padding-top: 6px; }
  .notesBox textarea{ min-height: 78px; padding: 10px 12px; }
  .right{ flex: 0 1 380px; }
  .headerRow{ gap: 12px !important; padding: 0 0 6px; }
}

@media (max-width: 1199.98px), (max-height: 759.98px){ body{ overflow: auto; } }

/* === Periods table: vertical scroll + sticky header === */
.periodsScroll{ overflow-x: auto; overflow-y: auto; max-height: 270px; }
@media (min-width: 1200px) and (min-height: 760px){ .periodsScroll{ max-height: 220px; } }

.periodsScroll .tableStyled thead th{ position: sticky; top: 0; z-index: 2; box-shadow: 0 1px 0 rgba(0,0,0,0.15); }
body.dark .periodsScroll .tableStyled thead th{ box-shadow: 0 1px 0 rgba(255,255,255,0.12); }



/* === Moto as tool button (replaces checkbox label) === */
.motoBtnWrap{ display:inline-flex; align-items:center; }
.motoHidden{ position:absolute !important; opacity:0 !important; pointer-events:none !important; width:1px !important; height:1px !important; overflow:hidden !important; }

.motoToolBtn{
  min-width: 86px;
}

.motoToolBtn.toolBtnActive{
  background: rgba(17,169,166,0.16) !important;
  border-color: rgba(17,169,166,0.55) !important;
}

body.dark .motoToolBtn.toolBtnActive{
  background: rgba(17,169,166,0.22) !important;
  border-color: rgba(17,169,166,0.65) !important;
}



/* === Layout reorg (table + frises) with spacing === */
.headerRow h1{ width:100%; text-align:center; }

.tableFriseRow{ display:flex; gap:18px; align-items:flex-start; margin-top: 10px; }
.tableCol{ flex:1 1 760px; min-width:0; display:flex; flex-direction:column; gap:12px; }
.friseCol{ flex:0 0 420px; min-width:0; display:flex; flex-direction:column; gap:12px; }

#totalMois, #interruptionTxt{ margin-top: 4px; }
.notesBox{ margin-top: 6px; }

@media (max-width: 1100px){
  .tableFriseRow{ flex-direction:column; }
  .friseCol{ flex:1 1 auto; width:100%; }
}

/* Indep + Hamon buttons: side-by-side */
.sectionToggleRow{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top: 4px; }
.sectionToggleRow .sectionToggleBtn{ margin-top: 0 !important; }

.sectionToggleBtn.toolBtnActive{ background: rgba(17,169,166,0.16) !important; border-color: rgba(17,169,166,0.55) !important; }
body.dark .sectionToggleBtn.toolBtnActive{ background: rgba(17,169,166,0.22) !important; border-color: rgba(17,169,166,0.65) !important; }

/* Type switch (light mode): improve readability / selection */
body:not(.dark) .typeSwitchToggle{ background: rgba(17,24,39,0.10); border-color: rgba(17,24,39,0.14); }
body:not(.dark) .typeSwitchToggle .typePill{ background: color-mix(in oklab, var(--accent) 10%, rgba(255,255,255,0.95)); border: 1px solid rgba(17,24,39,0.10); }


/* Update banner button */
#updateBanner{ display:none; }
#updateBanner button{ padding: 7px 12px; border-radius: 999px; border: 1px solid var(--softStroke, var(--border2)); background: rgba(255,255,255,0.70); color: var(--text); font-weight: 700; cursor: pointer; }
body.dark #updateBanner button{ background: rgba(255,255,255,0.06); border-color: rgba(255,255,255,0.16); color: rgba(255,255,255,0.92); }
#updateBanner button:hover{ filter: brightness(1.04); }



/* === Correction couleur : s√©lection pleine comme les outils (Indep/Hamon) === */
.sectionToggleBtn.toolBtnActive{
  background: var(--accent) !important;
  border-color: var(--accent) !important;
  color: #fff !important;
  box-shadow: 0 10px 22px rgba(17,169,166,0.20) !important;
  filter: brightness(1.03) !important;
}

body.dark .sectionToggleBtn.toolBtnActive{
  background: var(--accent) !important;
  border-color: var(--accent) !important;
  color: rgba(255,255,255,0.92) !important;
  box-shadow: 0 10px 22px rgba(17,169,166,0.20) !important;
  filter: brightness(1.03) !important;
}

.sectionToggleBtn.toolBtnActive:active,
.sectionToggleBtn.toolBtnActive:focus,
.sectionToggleBtn.toolBtnActive:focus-visible{
  box-shadow: 0 10px 22px rgba(17,169,166,0.20) !important;
  filter: brightness(1.03) !important;
  transform: none !important;
}


/* === Correction s√©lection Moto : m√™me style que les outils === */
.motoToolBtn.toolBtnActive{
  background: var(--accent) !important;
  border-color: var(--accent) !important;
  color: #fff !important;
  box-shadow: 0 10px 22px rgba(17,169,166,0.20) !important;
  filter: brightness(1.03) !important;
}

body.dark .motoToolBtn.toolBtnActive{
  background: var(--accent) !important;
  border-color: var(--accent) !important;
  color: rgba(255,255,255,0.92) !important;
  box-shadow: 0 10px 22px rgba(17,169,166,0.20) !important;
  filter: brightness(1.03) !important;
}

.motoToolBtn.toolBtnActive:active,
.motoToolBtn.toolBtnActive:focus,
.motoToolBtn.toolBtnActive:focus-visible{
  box-shadow: 0 10px 22px rgba(17,169,166,0.20) !important;
  filter: brightness(1.03) !important;
  transform: none !important;
}


/* --- Notes copy button fixes --- */
.notesBox .notesHeader{display:flex !important;flex-direction:row !important;align-items:center !important;justify-content:flex-start !important;gap:8px !important;}
.notesBox .notesHeader h2{margin:0 !important;line-height:1 !important;}
.notesBox .copyIconBtn{width:28px !important;height:28px !important;min-width:28px !important;min-height:28px !important;padding:0 !important;border-radius:999px !important;display:inline-flex !important;align-items:center !important;justify-content:center !important;}
.notesBox .copyIconBtn svg{width:16px !important;height:16px !important;display:block !important;fill:currentColor !important;}
.notesBox .copyIconBtn path{fill:currentColor !important;}



/* --- Notes header: put copy button at far right --- */
.notesBox .notesHeader{display:flex !important; flex-direction:row !important; align-items:center !important; justify-content:flex-start !important; gap:8px !important;}
.notesBox .notesHeader h2{margin:0 !important; line-height:1 !important;}
.notesBox .notesHeader #btnCopyNotes{margin-left:auto !important;}



/* --- Notes: extra spacing under header so textarea doesn't collide with copy button --- */
.notesBox .notesHeader{margin-bottom:10px !important;}



/* --- Date d'effet: label in bold + pill for readability --- */
.row label[for="dateEffet"]{
  font-weight:800 !important;
  display:inline-flex;
  align-items:center;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid var(--softStroke, var(--border2));
  background:color-mixin(in oklab, var(--card) 86%, transparent);
  box-shadow:var(--shadowB, none);
}



/* --- Date d'effet: bubble group (label + input + Moto + Effacer) --- */
.dateEffetBubble{
  display:inline-flex;
  align-items:center;
  gap:10px;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid var(--softStroke, var(--border2));
  background:color-mixin(in oklab, var(--card) 86%, transparent);
  box-shadow:var(--shadowB, none);
}

.dateEffetBubble label[for="dateEffet"]{
  font-family:inherit !important;
  font-size:12px !important;
  font-weight:700 !important;
  letter-spacing:-0.1px;
  margin:0 !important;
  padding:0 !important;
  border:0 !important;
  background:transparent !important;
  box-shadow:none !important;
  display:inline-flex;
  align-items:center;
  white-space:nowrap;
}

/* Ensure prior single-label pill styles don't override inside the bubble */
.dateEffetBubble label[for="dateEffet"],
.dateEffetBubble label[for="dateEffet"] strong{
  border:0 !important;
  background:transparent !important;
  box-shadow:none !important;
}

/* Keep the input visually consistent inside the bubble */
.dateEffetBubble input#dateEffet{
  width:110px;
}

</style>
</head>
<body>
<div class="app">
<div class="left">
<div class="row headerRow" style="justify-content: space-between; gap: 10px;; text-align:center; justify-content:center">
<h1>Outil de validation</h1>
<div class="row headerBtns" style="gap:8px;">
<button class="pillBtn" id="btnCrmTable" title="Afficher/Masquer le tableau CRM" type="button">Tableau CRM</button>
<button class="pillBtn" id="btnCrmTool" title="Afficher/Masquer l‚Äôoutil de calcul CRM" type="button">Impact CRM</button>
<button class="pillBtn" id="btnCrmPermit" title="Afficher/Masquer l‚Äôoutil CRM max via date de permis" type="button">CRM max (permis)</button>
</div>
</div>
<button aria-label="Basculer le th√®me" class="themeFab" id="btnTheme" title="Basculer le th√®me" type="button">
<span aria-hidden="true" id="themeIcon"></span>
</button>
<div id="updateBanner">
<div>
  <span id="updateText"></span>
  &nbsp;
  <button id="btnUpdateNow" type="button" title="Recharge la page pour charger la derni√®re version">Mettre √† jour</button>
</div>
</div>
<div class="card cardSmall" id="crmTableWrap">
<h2>√âvolution standard du CRM</h2>
<div class="muted" style="margin-top:6px;">
          Tableau standard (valeurs arrondies) : 0 an = 1,00 ; 13 ans = 0,50.
        </div>
<div class="tableScroll" style="margin-top:8px;">
<table class="tableStyled" id="crmTable">
<thead>
<tr><th>Ann√©e sans sinistre</th><th>CRM</th></tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>
<div class="card cardSmall" id="crmToolWrap">
<h2>Outil de calcul CRM</h2>
<div class="row" style="margin-top:8px; gap:8px;">
<label for="crmToolInput">CRM :</label>
<input id="crmToolInput" inputmode="decimal" maxlength="10" placeholder="1,00" type="text"/>
<div class="result" id="crmToolResult" style="min-width:180px;"></div>
</div>
<div class="row" style="margin-top:8px; gap:8px;">
<button id="btnCrmNone" type="button">Aucun sinistre responsable</button>
<button id="btnCrm50" type="button">Sinistre 50%</button>
<button id="btnCrm100" type="button">Sinistre 100%</button>
</div>
<div class="crmTrail" id="crmToolTrail"></div>
<div class="muted" style="margin-top:6px;">
          R√©sultat tronqu√© √† 2 d√©cimales (pas d‚Äôarrondi).
        </div>
</div>
<div class="card cardSmall" id="crmPermitWrap">
<h2>CRM maximum (date de permis)</h2>
<div class="muted" style="margin-top:6px;">
          R√®gle : on applique le tableau CRM. Une nouvelle ‚Äúann√©e‚Äù est accord√©e d√®s +9 mois sur l‚Äôann√©e en cours.
        </div>
<div class="row" style="margin-top:8px; gap:8px;">
<label for="permitDate">Date de permis :</label>
<input id="permitDate" maxlength="10" type="text"/>
<div class="result" id="permitCrmResult" style="min-width:220px;"></div>
</div>
<div class="muted" id="permitCrmDetail" style="margin-top:6px;"></div>
</div>
<div class="row">
<span class="dateEffetBubble"><label for="dateEffet">Date d'effet :</label>
<input id="dateEffet" maxlength="10" type="text"/>
<div class="motoBtnWrap"> <input class="motoHidden" id="moto" type="checkbox"/> <button aria-pressed="false" class="pillBtn motoToolBtn" id="btnMoto" title="Fen√™tre moto : 24 mois" type="button">Moto</button></div>
<button id="btnClear" type="button">Effacer</button></span>
</div>






<div class="tableFriseRow"><div class="tableCol"><div class="tableScroll periodsScroll">
<table class="tableStyled" id="periodsTable">
<thead>
<tr>
<th>#</th>
<th>Type</th>
<th>D√©but</th>
<th>Fin</th>
<th>Mois</th>
<th>
<span class="thInfoWrap">
                  Indicatif frise
                  <button aria-label="Info Indicatif frise" class="infoBtn" id="crmInfoBtn" title="Info" type="button">i</button>
</span>
</th>
</tr>
</thead>
<tbody>
<tr><td>1</td><td><select class="typeSelectHidden" id="type1"><option selected="" value="AUTO">Auto</option><option value="MOTO">Moto</option></select>
<div aria-checked="false" aria-label="Type 1 (Auto/Moto)" class="typeSwitchToggle" data-target="type1" role="switch" tabindex="0">
<span class="typeText typeTextAuto">Auto</span>
<span class="typeText typeTextMoto">Moto</span>
<span aria-hidden="true" class="typePill"></span>
</div></td><td><input id="deb1" maxlength="10" type="text"/></td><td><input id="fin1" maxlength="10" type="text"/></td><td id="mois1"></td><td><input class="crmInput" id="crm1" maxlength="8" type="text"/></td></tr>
<tr><td>2</td><td><select class="typeSelectHidden" id="type2"><option selected="" value="AUTO">Auto</option><option value="MOTO">Moto</option></select>
<div aria-checked="false" aria-label="Type 1 (Auto/Moto)" class="typeSwitchToggle" data-target="type2" role="switch" tabindex="0">
<span class="typeText typeTextAuto">Auto</span>
<span class="typeText typeTextMoto">Moto</span>
<span aria-hidden="true" class="typePill"></span>
</div></td><td><input id="deb2" maxlength="10" type="text"/></td><td><input id="fin2" maxlength="10" type="text"/></td><td id="mois2"></td><td><input class="crmInput" id="crm2" maxlength="8" type="text"/></td></tr>
<tr><td>3</td><td><select class="typeSelectHidden" id="type3"><option selected="" value="AUTO">Auto</option><option value="MOTO">Moto</option></select>
<div aria-checked="false" aria-label="Type 1 (Auto/Moto)" class="typeSwitchToggle" data-target="type3" role="switch" tabindex="0">
<span class="typeText typeTextAuto">Auto</span>
<span class="typeText typeTextMoto">Moto</span>
<span aria-hidden="true" class="typePill"></span>
</div></td><td><input id="deb3" maxlength="10" type="text"/></td><td><input id="fin3" maxlength="10" type="text"/></td><td id="mois3"></td><td><input class="crmInput" id="crm3" maxlength="8" type="text"/></td></tr>
<tr><td>4</td><td><select class="typeSelectHidden" id="type4"><option selected="" value="AUTO">Auto</option><option value="MOTO">Moto</option></select>
<div aria-checked="false" aria-label="Type 1 (Auto/Moto)" class="typeSwitchToggle" data-target="type4" role="switch" tabindex="0">
<span class="typeText typeTextAuto">Auto</span>
<span class="typeText typeTextMoto">Moto</span>
<span aria-hidden="true" class="typePill"></span>
</div></td><td><input id="deb4" maxlength="10" type="text"/></td><td><input id="fin4" maxlength="10" type="text"/></td><td id="mois4"></td><td><input class="crmInput" id="crm4" maxlength="8" type="text"/></td></tr>
<tr><td>5</td><td><select class="typeSelectHidden" id="type5"><option selected="" value="AUTO">Auto</option><option value="MOTO">Moto</option></select>
<div aria-checked="false" aria-label="Type 1 (Auto/Moto)" class="typeSwitchToggle" data-target="type5" role="switch" tabindex="0">
<span class="typeText typeTextAuto">Auto</span>
<span class="typeText typeTextMoto">Moto</span>
<span aria-hidden="true" class="typePill"></span>
</div></td><td><input id="deb5" maxlength="10" type="text"/></td><td><input id="fin5" maxlength="10" type="text"/></td><td id="mois5"></td><td><input class="crmInput" id="crm5" maxlength="8" type="text"/></td></tr>
<tr><td>6</td><td><select class="typeSelectHidden" id="type6"><option selected="" value="AUTO">Auto</option><option value="MOTO">Moto</option></select>
<div aria-checked="false" aria-label="Type 1 (Auto/Moto)" class="typeSwitchToggle" data-target="type6" role="switch" tabindex="0">
<span class="typeText typeTextAuto">Auto</span>
<span class="typeText typeTextMoto">Moto</span>
<span aria-hidden="true" class="typePill"></span>
</div></td><td><input id="deb6" maxlength="10" type="text"/></td><td><input id="fin6" maxlength="10" type="text"/></td><td id="mois6"></td><td><input class="crmInput" id="crm6" maxlength="8" type="text"/></td></tr>
<tr><td>7</td><td><select class="typeSelectHidden" id="type7"><option selected="" value="AUTO">Auto</option><option value="MOTO">Moto</option></select>
<div aria-checked="false" aria-label="Type 1 (Auto/Moto)" class="typeSwitchToggle" data-target="type7" role="switch" tabindex="0">
<span class="typeText typeTextAuto">Auto</span>
<span class="typeText typeTextMoto">Moto</span>
<span aria-hidden="true" class="typePill"></span>
</div></td><td><input id="deb7" maxlength="10" type="text"/></td><td><input id="fin7" maxlength="10" type="text"/></td><td id="mois7"></td><td><input class="crmInput" id="crm7" maxlength="8" type="text"/></td></tr>
<tr><td>8</td><td><select class="typeSelectHidden" id="type8"><option selected="" value="AUTO">Auto</option><option value="MOTO">Moto</option></select>
<div aria-checked="false" aria-label="Type 1 (Auto/Moto)" class="typeSwitchToggle" data-target="type8" role="switch" tabindex="0">
<span class="typeText typeTextAuto">Auto</span>
<span class="typeText typeTextMoto">Moto</span>
<span aria-hidden="true" class="typePill"></span>
</div></td><td><input id="deb8" maxlength="10" type="text"/></td><td><input id="fin8" maxlength="10" type="text"/></td><td id="mois8"></td><td><input class="crmInput" id="crm8" maxlength="8" type="text"/></td></tr>
<tr><td>9</td><td><select class="typeSelectHidden" id="type9"><option selected="" value="AUTO">Auto</option><option value="MOTO">Moto</option></select>
<div aria-checked="false" aria-label="Type 1 (Auto/Moto)" class="typeSwitchToggle" data-target="type9" role="switch" tabindex="0">
<span class="typeText typeTextAuto">Auto</span>
<span class="typeText typeTextMoto">Moto</span>
<span aria-hidden="true" class="typePill"></span>
</div></td><td><input id="deb9" maxlength="10" type="text"/></td><td><input id="fin9" maxlength="10" type="text"/></td><td id="mois9"></td><td><input class="crmInput" id="crm9" maxlength="8" type="text"/></td></tr>
<tr><td>10</td><td><select class="typeSelectHidden" id="type10"><option selected="" value="AUTO">Auto</option><option value="MOTO">Moto</option></select>
<div aria-checked="false" aria-label="Type 1 (Auto/Moto)" class="typeSwitchToggle" data-target="type10" role="switch" tabindex="0">
<span class="typeText typeTextAuto">Auto</span>
<span class="typeText typeTextMoto">Moto</span>
<span aria-hidden="true" class="typePill"></span>
</div></td><td><input id="deb10" maxlength="10" type="text"/></td><td><input id="fin10" maxlength="10" type="text"/></td><td id="mois10"></td><td><input class="crmInput" id="crm10" maxlength="8" type="text"/></td></tr>
<tr><td>11</td><td><select class="typeSelectHidden" id="type11"><option selected="" value="AUTO">Auto</option><option value="MOTO">Moto</option></select>
<div aria-checked="false" aria-label="Type 1 (Auto/Moto)" class="typeSwitchToggle" data-target="type11" role="switch" tabindex="0">
<span class="typeText typeTextAuto">Auto</span>
<span class="typeText typeTextMoto">Moto</span>
<span aria-hidden="true" class="typePill"></span>
</div></td><td><input id="deb11" maxlength="10" type="text"/></td><td><input id="fin11" maxlength="10" type="text"/></td><td id="mois11"></td><td><input class="crmInput" id="crm11" maxlength="8" type="text"/></td></tr>
<tr><td>12</td><td><select class="typeSelectHidden" id="type12"><option selected="" value="AUTO">Auto</option><option value="MOTO">Moto</option></select>
<div aria-checked="false" aria-label="Type 1 (Auto/Moto)" class="typeSwitchToggle" data-target="type12" role="switch" tabindex="0">
<span class="typeText typeTextAuto">Auto</span>
<span class="typeText typeTextMoto">Moto</span>
<span aria-hidden="true" class="typePill"></span>
</div></td><td><input id="deb12" maxlength="10" type="text"/></td><td><input id="fin12" maxlength="10" type="text"/></td><td id="mois12"></td><td><input class="crmInput" id="crm12" maxlength="8" type="text"/></td></tr>
<tr><td>13</td><td><select class="typeSelectHidden" id="type13"><option selected="" value="AUTO">Auto</option><option value="MOTO">Moto</option></select>
<div aria-checked="false" aria-label="Type 1 (Auto/Moto)" class="typeSwitchToggle" data-target="type13" role="switch" tabindex="0">
<span class="typeText typeTextAuto">Auto</span>
<span class="typeText typeTextMoto">Moto</span>
<span aria-hidden="true" class="typePill"></span>
</div></td><td><input id="deb13" maxlength="10" type="text"/></td><td><input id="fin13" maxlength="10" type="text"/></td><td id="mois13"></td><td><input class="crmInput" id="crm13" maxlength="8" type="text"/></td></tr>
<tr><td>14</td><td><select class="typeSelectHidden" id="type14"><option selected="" value="AUTO">Auto</option><option value="MOTO">Moto</option></select>
<div aria-checked="false" aria-label="Type 1 (Auto/Moto)" class="typeSwitchToggle" data-target="type14" role="switch" tabindex="0">
<span class="typeText typeTextAuto">Auto</span>
<span class="typeText typeTextMoto">Moto</span>
<span aria-hidden="true" class="typePill"></span>
</div></td><td><input id="deb14" maxlength="10" type="text"/></td><td><input id="fin14" maxlength="10" type="text"/></td><td id="mois14"></td><td><input class="crmInput" id="crm14" maxlength="8" type="text"/></td></tr>
<tr><td>15</td><td><select class="typeSelectHidden" id="type15"><option selected="" value="AUTO">Auto</option><option value="MOTO">Moto</option></select>
<div aria-checked="false" aria-label="Type 1 (Auto/Moto)" class="typeSwitchToggle" data-target="type15" role="switch" tabindex="0">
<span class="typeText typeTextAuto">Auto</span>
<span class="typeText typeTextMoto">Moto</span>
<span aria-hidden="true" class="typePill"></span>
</div></td><td><input id="deb15" maxlength="10" type="text"/></td><td><input id="fin15" maxlength="10" type="text"/></td><td id="mois15"></td><td><input class="crmInput" id="crm15" maxlength="8" type="text"/></td></tr>
<tr><td>16</td><td><select class="typeSelectHidden" id="type16"><option selected="" value="AUTO">Auto</option><option value="MOTO">Moto</option></select>
<div aria-checked="false" aria-label="Type 1 (Auto/Moto)" class="typeSwitchToggle" data-target="type16" role="switch" tabindex="0">
<span class="typeText typeTextAuto">Auto</span>
<span class="typeText typeTextMoto">Moto</span>
<span aria-hidden="true" class="typePill"></span>
</div></td><td><input id="deb16" maxlength="10" type="text"/></td><td><input id="fin16" maxlength="10" type="text"/></td><td id="mois16"></td><td><input class="crmInput" id="crm16" maxlength="8" type="text"/></td></tr>
<tr><td>17</td><td><select class="typeSelectHidden" id="type17"><option selected="" value="AUTO">Auto</option><option value="MOTO">Moto</option></select>
<div aria-checked="false" aria-label="Type 1 (Auto/Moto)" class="typeSwitchToggle" data-target="type17" role="switch" tabindex="0">
<span class="typeText typeTextAuto">Auto</span>
<span class="typeText typeTextMoto">Moto</span>
<span aria-hidden="true" class="typePill"></span>
</div></td><td><input id="deb17" maxlength="10" type="text"/></td><td><input id="fin17" maxlength="10" type="text"/></td><td id="mois17"></td><td><input class="crmInput" id="crm17" maxlength="8" type="text"/></td></tr>
<tr><td>18</td><td><select class="typeSelectHidden" id="type18"><option selected="" value="AUTO">Auto</option><option value="MOTO">Moto</option></select>
<div aria-checked="false" aria-label="Type 1 (Auto/Moto)" class="typeSwitchToggle" data-target="type18" role="switch" tabindex="0">
<span class="typeText typeTextAuto">Auto</span>
<span class="typeText typeTextMoto">Moto</span>
<span aria-hidden="true" class="typePill"></span>
</div></td><td><input id="deb18" maxlength="10" type="text"/></td><td><input id="fin18" maxlength="10" type="text"/></td><td id="mois18"></td><td><input class="crmInput" id="crm18" maxlength="8" type="text"/></td></tr>
<tr><td>19</td><td><select class="typeSelectHidden" id="type19"><option selected="" value="AUTO">Auto</option><option value="MOTO">Moto</option></select>
<div aria-checked="false" aria-label="Type 1 (Auto/Moto)" class="typeSwitchToggle" data-target="type19" role="switch" tabindex="0">
<span class="typeText typeTextAuto">Auto</span>
<span class="typeText typeTextMoto">Moto</span>
<span aria-hidden="true" class="typePill"></span>
</div></td><td><input id="deb19" maxlength="10" type="text"/></td><td><input id="fin19" maxlength="10" type="text"/></td><td id="mois19"></td><td><input class="crmInput" id="crm19" maxlength="8" type="text"/></td></tr>
<tr><td>20</td><td><select class="typeSelectHidden" id="type20"><option selected="" value="AUTO">Auto</option><option value="MOTO">Moto</option></select>
<div aria-checked="false" aria-label="Type 1 (Auto/Moto)" class="typeSwitchToggle" data-target="type20" role="switch" tabindex="0">
<span class="typeText typeTextAuto">Auto</span>
<span class="typeText typeTextMoto">Moto</span>
<span aria-hidden="true" class="typePill"></span>
</div></td><td><input id="deb20" maxlength="10" type="text"/></td><td><input id="fin20" maxlength="10" type="text"/></td><td id="mois20"></td><td><input class="crmInput" id="crm20" maxlength="8" type="text"/></td></tr>
</tbody>
</table>
</div><div class="result" id="totalMois"></div><div class="result" id="interruptionTxt"></div><div class="card cardSmall notesBox">
  <div class="notesHeader">
    <h2>Notes</h2>
  <button type="button" class="copyIconBtn" id="btnCopyNotes" title="Copier les notes" aria-label="Copier les notes" onclick="copyNotesToClipboard();">
      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" style="fill:currentColor">
        <path d="M16 1H6c-1.1 0-2 .9-2 2v12h2V3h10V1zm3 4H10c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h9c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H10V7h9v14z"/>
      </svg>
    </button>
    
  </div>
<textarea id="notes" placeholder="Notes / observations..."></textarea>
</div><div class="error" id="errors"></div><div class="sectionToggleRow"><button class="pillBtn sectionToggleBtn" id="btnToggleIndep" type="button">P√©riode pr√©cise</button><button class="pillBtn sectionToggleBtn" id="btnToggleHamon" type="button">Hamon</button></div><div class="card cardSmall" id="indepCard" style="display:none;">
<h2>Calcul ind√©pendant d'une p√©riode</h2>
<div class="row" style="margin-top:6px;">
<label for="debIndep">D√©but :</label>
<input id="debIndep" maxlength="10" type="text"/>
<label for="finIndep">Fin :</label>
<input id="finIndep" maxlength="10" type="text"/>
</div>
<div class="result" id="resultIndep" style="margin-top:8px;"></div>
<div class="muted">R√©sultat en ann√©es / mois / jours (calcul calendaire).</div>
</div><div class="card cardSmall" id="hamonCard" style="display:none;">
<h2>Hamon (Mieux Assur√©)</h2>
<div class="row" style="margin-top:6px;">
<label for="dateEnvoiHamon">Envoi :</label>
<input id="dateEnvoiHamon" maxlength="10" type="text"/>
</div>
<div class="result" id="resultHamon" style="margin-top:8px;"></div>
<div class="muted">Effet = envoi + 33 jours.</div>
</div></div><div class="friseCol"><div class="card" id="cardAuto">
<h2>Frise AUTO</h2>
<div class="muted" id="legendAuto" style="margin:6px 0 6px 0;"></div>
<canvas height="136" id="canvasAuto" width="420"></canvas>
<div class="interruptions" id="interruptionsAuto"></div>
</div><div class="card" id="cardMoto" style="display:none;">
<h2>Frise MOTO</h2>
<div class="muted" id="legendMoto" style="margin:6px 0 6px 0;"></div>
<canvas height="136" id="canvasMoto" width="420"></canvas>
<div class="interruptions" id="interruptionsMoto"></div>
</div></div></div><div class="metaWrap">
<button aria-expanded="false" class="metaBtn" id="btnMeta" type="button">Infos auteur / version</button>
</div>
<div class="metaPanel" id="metaPanel">
<div><strong>¬© 2026 PHILLIPPON Johann</strong> ‚Äî Tous droits r√©serv√©s.</div>
<div style="margin-top:6px;">
          Consultation autoris√©e. Toute reproduction/copie (y compris interne), modification/adaptation, diffusion/partage, ou usage commercial,
          total ou partiel, est interdite sans autorisation √©crite pr√©alable de l‚Äôauteur.
        </div>
<div class="mutedLine" id="metaVersionLine" style="margin-top:8px;"></div>
</div>
</div>

</div>
<div aria-live="polite" class="tooltip" id="crmTooltip" role="dialog"></div>
<script>
    const LOCAL_VERSION = "0.27";
    const VERSION_URL = "https://gist.githubusercontent.com/Lemtosh/ac7fc859fe26f28a17f86fa73c4a4e95/raw/version.json";

    function cmpVersion(a, b) {
      const pa = String(a).split('.').map(n => parseInt(n, 10) || 0);
      const pb = String(b).split('.').map(n => parseInt(n, 10) || 0);
      const len = Math.max(pa.length, pb.length);
      for (let i = 0; i < len; i++) {
        const x = pa[i] ?? 0, y = pb[i] ?? 0;
        if (x > y) return 1;
        if (x < y) return -1;
      }
      return 0;
    }

    async function checkForUpdate() {
      try {
        const res = await fetch(VERSION_URL, { cache: "no-store" });
        if (!res.ok) return;
        const data = await res.json();
        const remoteVersion = data?.version;
        const downloadUrl = data?.downloadUrl;

        if (remoteVersion && downloadUrl && cmpVersion(remoteVersion, LOCAL_VERSION) > 0) {
          document.getElementById("updateText").textContent =
            `Nouvelle version disponible (${remoteVersion}). Vous utilisez la ${LOCAL_VERSION}.`;
          /* updateLink removed */
          document.getElementById("updateBanner").style.display = "block";wireUpdateNow(remoteVersion);
        }
      } catch (e) {}
    }

    /* ===== Th√®me ===== */
    function updateThemeButton(){
      const isDark = document.body.classList.contains('dark');
      document.getElementById('themeIcon').textContent = isDark ? '‚òÄ' : 'üåô';
    }
    function applyTheme(isDark) {
      document.body.classList.toggle('dark', !!isDark);
      updateThemeButton();
    }
    function initTheme() {
      const saved = localStorage.getItem('theme');
      if (saved === 'dark') applyTheme(true);
      else if (saved === 'light') applyTheme(false);
      else applyTheme(false);
    }
    function toggleTheme() {
      const isDark = !document.body.classList.contains('dark');
      applyTheme(isDark);
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
      calculer();
    }

    /* ===== Meta panel ===== */
    function toggleMeta(){
      const panel = document.getElementById('metaPanel');
      const btn = document.getElementById('btnMeta');
      const isOpen = panel.style.display === 'block';
      panel.style.display = isOpen ? 'none' : 'block';
      btn.setAttribute('aria-expanded', isOpen ? 'false' : 'true');
      if (!isOpen) panel.scrollIntoView({ block: 'nearest' });
    }
    function renderMetaVersion(){
      document.getElementById('metaVersionLine').textContent = `Version : v${LOCAL_VERSION}`;
    }

    /* ===== Tableau CRM (source) ===== */
    const CRM_TABLE = [
      { year: 0,  crm: 1.00 },
      { year: 1,  crm: 0.95 },
      { year: 2,  crm: 0.90 },
      { year: 3,  crm: 0.85 },
      { year: 4,  crm: 0.80 },
      { year: 5,  crm: 0.76 },
      { year: 6,  crm: 0.72 },
      { year: 7,  crm: 0.68 },
      { year: 8,  crm: 0.64 },
      { year: 9,  crm: 0.60 },
      { year: 10, crm: 0.57 },
      { year: 11, crm: 0.54 },
      { year: 12, crm: 0.51 },
      { year: 13, crm: 0.50 }
    ];
    function buildCrmEvolutionRows(){ return CRM_TABLE.slice(); }
    function renderCrmTable(){
      const tbody = document.querySelector('#crmTable tbody');
      tbody.innerHTML = '';
      buildCrmEvolutionRows().forEach(r => {
        const tr = document.createElement('tr');
        const tdY = document.createElement('td');
        const tdC = document.createElement('td');
        tdY.textContent = String(r.year);
        tdC.textContent = String(r.crm.toFixed(2)).replace('.', ',');
        tr.appendChild(tdY);
        tr.appendChild(tdC);
        tbody.appendChild(tr);
      });
    }

    /* ===== Panels CRM: 1 seul ouvert ===== */
    function setWrapOpen(wrapId, btnId, isOpen, closedLabel, openedLabel, onOpen){
      const wrap = document.getElementById(wrapId);
      const btn = document.getElementById(btnId);
      if (!wrap || !btn) return;
      wrap.style.display = isOpen ? 'block' : 'none';
      btn.textContent = isOpen ? openedLabel : closedLabel;

      // √©tat visuel : bouton s√©lectionn√©
      btn.classList.toggle('toolBtnActive', !!isOpen);
      if (isOpen && typeof onOpen === 'function') onOpen();
    }
    function closeAllCrmPanels(except){ // except: 'table' | 'tool' | 'permit' | null
      if (except !== 'table') {
        setWrapOpen('crmTableWrap','btnCrmTable',false,'Tableau CRM','Masquer tableau CRM');
      }
      if (except !== 'tool') {
        setWrapOpen('crmToolWrap','btnCrmTool',false,'Impact CRM','Masquer Impact CRM');
      }
      if (except !== 'permit') {
        setWrapOpen('crmPermitWrap','btnCrmPermit',false,'CRM max (permis)','Masquer CRM max (permis)');
      }
    }

    function toggleCrmTable(){
      const wrap = document.getElementById('crmTableWrap');
      const isOpen = wrap.style.display === 'block';
      if (!isOpen) closeAllCrmPanels('table');
      setWrapOpen('crmTableWrap','btnCrmTable',!isOpen,'Tableau CRM','Masquer tableau CRM', renderCrmTable);
    }

    /* ===== Impact CRM (sinistres) ===== */
    const CRM_MAX = 3.50;

    const CRM_ACTIONS = [
      { key: 'none', label: 'Aucun sinistre responsable', factor: 0.95, short: '√ó0,95' },
      { key: '50',   label: 'Sinistre 50%',              factor: 1.125, short: '√ó1,125' },
      { key: '100',  label: 'Sinistre 100%',             factor: 1.25, short: '√ó1,25' }
    ];

    let crmBaseValue = null;
    let crmCurrentValue = null;
    let crmClicks = [];

    function toggleCrmTool(){
      const wrap = document.getElementById('crmToolWrap');
      const isOpen = wrap.style.display === 'block';
      if (!isOpen) closeAllCrmPanels('tool');
      setWrapOpen('crmToolWrap','btnCrmTool',!isOpen,'Impact CRM','Masquer Impact CRM', updateCrmToolUI);
    }

    function parseCrmInput(v){
      const s = String(v || '').trim();
      if (s === '') return null;
      const n = Number(s.replace(',', '.'));
      if (!Number.isFinite(n)) return null;
      return n;
    }
    function trunc2(n){ return Math.floor(n * 100) / 100; }
    function format2FR(n){ return String(n.toFixed(2)).replace('.', ','); }

    function resetCrmToolState(){
      crmBaseValue = null;
      crmCurrentValue = null;
      crmClicks = [];
      updateCrmToolUI();
    }
    function getClicksSummary(){
      if (!crmClicks.length) return '';
      const counts = {};
      crmClicks.forEach(a => { counts[a.key] = (counts[a.key] || 0) + 1; });

      const parts = [];
      CRM_ACTIONS.forEach(a => {
        const c = counts[a.key] || 0;
        if (c > 0) parts.push(`${c}√ó ${a.label} (${a.short})`);
      });
      return parts.join(' | ');
    }
    function updateCrmToolUI(){
      const resultEl = document.getElementById('crmToolResult');
      const trailEl = document.getElementById('crmToolTrail');
      const inputVal = parseCrmInput(document.getElementById('crmToolInput').value);

      if (inputVal === null){
        resultEl.textContent = '';
        trailEl.textContent = '';
        return;
      }
      if (crmBaseValue === null){
        crmBaseValue = inputVal;
        crmCurrentValue = inputVal;
      }

      const baseTxt = `CRM d√©part : ${format2FR(trunc2(crmBaseValue))}`;
      const displayed = Math.min(trunc2(crmCurrentValue), CRM_MAX);
      const curTxt  = `R√©sultat : ${format2FR(displayed)}`;
      resultEl.textContent = curTxt;

      const summary = getClicksSummary();
      if (!summary) trailEl.innerHTML = `<strong>${baseTxt}</strong>\nAucune action appliqu√©e.`;
      else trailEl.innerHTML = `<strong>${baseTxt}</strong>\nActions : ${summary}`;
    }
    function applyCrmAction(action){
      const inputVal = parseCrmInput(document.getElementById('crmToolInput').value);
      if (inputVal === null) return;

      if (crmBaseValue === null){
        crmBaseValue = inputVal;
        crmCurrentValue = inputVal;
        crmClicks = [];
      }
      crmCurrentValue = trunc2(crmCurrentValue * action.factor);
      crmCurrentValue = Math.min(crmCurrentValue, CRM_MAX);
      crmClicks.push(action);
      updateCrmToolUI();
    }

    /* ===== CRM max (date permis) ===== */
    function toggleCrmPermit(){
      const wrap = document.getElementById('crmPermitWrap');
      const isOpen = wrap.style.display === 'block';
      if (!isOpen) closeAllCrmPanels('permit');
      setWrapOpen('crmPermitWrap','btnCrmPermit',!isOpen,'CRM max (permis)','Masquer CRM max (permis)', updatePermitCrm);
    }

    function parseDateFlexible(str) {
      if (!str) return null;
      const s = String(str).trim();
      if (s === "") return null;
      const digits = s.replace(/\D/g, '');
      if (!(digits.length === 6 || digits.length === 8)) return null;
      const dd = parseInt(digits.slice(0, 2), 10);
      const mm = parseInt(digits.slice(2, 4), 10);
      let yyyy = digits.length === 6 ? 2000 + parseInt(digits.slice(4, 6), 10) : parseInt(digits.slice(4, 8), 10);
      const monthIndex = mm - 1;
      const d = new Date(yyyy, monthIndex, dd);
      if (d.getFullYear() !== yyyy || d.getMonth() !== monthIndex || d.getDate() !== dd) return null;
      return d;
    }
    function formatDateFR(d) {
      const dd = String(d.getDate()).padStart(2, '0');
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      return `${dd}/${mm}/${d.getFullYear()}`;
    }

    // --- UI friendly date normalization (JJ/MM/YYYY) ---
    // On blur: if the user typed an accepted date format, we rewrite it as JJ/MM/YYYY.
    function formatToDDMMYYYYFromInput(raw){
      const s = String(raw || '').trim();
      if (!s) return '';
      const d = parseDateFlexible(s);
      if (!d) return null; // invalid
      return formatDateFR(d);
    }

    function attachAutoFormatDateInput(el){
      if (!el) return;
      el.addEventListener('blur', () => {
        const raw = String(el.value || '').trim();
        if (!raw) return;
        const formatted = formatToDDMMYYYYFromInput(raw);
        if (formatted) {
          el.value = formatted;
          // trigger existing reactive logic
          el.dispatchEvent(new Event('input', { bubbles: true }));
          el.dispatchEvent(new Event('change', { bubbles: true }));
        }
      });
    }

    function initAutoFormatAllDateInputs(){
      const ids = ['dateEffet','permitDate','debIndep','finIndep','dateEnvoiHamon'];
      for (let i=1;i<=20;i++){ ids.push('deb'+i,'fin'+i); }
      ids.forEach(id => attachAutoFormatDateInput(document.getElementById(id)));
    }


    function monthsAndRemainderDays(start, end) {
      if (end < start) return { months: 0, remDays: 0 };
      let months = (end.getFullYear() - start.getFullYear()) * 12 + (end.getMonth() - start.getMonth());
      let anchor = new Date(start.getFullYear(), start.getMonth() + months, start.getDate());
      if (anchor > end) { months -= 1; anchor = new Date(start.getFullYear(), start.getMonth() + months, start.getDate()); }
      const remDays = Math.floor((end - anchor) / (1000 * 60 * 60 * 24));
      return { months: Math.max(0, months), remDays: Math.max(0, remDays) };
    }

    function computePermitYearsRounded(permitDate, today){
      const r = monthsAndRemainderDays(permitDate, today);
      const wholeYears = Math.floor(r.months / 12);
      const monthsInCurrentYear = r.months % 12;

      // R√®gle demand√©e : d√®s 9 mois dans l'ann√©e, on "accorde" une √©volution (on passe √† l'ann√©e suivante)
      const roundedYears = wholeYears + (monthsInCurrentYear >= 9 ? 1 : 0);
      return { wholeYears, monthsInCurrentYear, roundedYears, totalMonths: r.months, remDays: r.remDays };
    }

    function getCrmForYears(years){
      const y = Math.max(0, Math.min(13, years));
      const row = CRM_TABLE.find(r => r.year === y) || CRM_TABLE[CRM_TABLE.length - 1];
      return row.crm;
    }

    function updatePermitCrm(){
      const resEl = document.getElementById('permitCrmResult');
      const detEl = document.getElementById('permitCrmDetail');
      const d = parseDateFlexible(document.getElementById('permitDate').value);

      resEl.textContent = '';
      detEl.textContent = '';

      const raw = String(document.getElementById('permitDate').value || '').trim();
      if (raw === '') return;

      if (!d){
        resEl.textContent = 'Date invalide.';
        return;
      }

      const today = new Date();
      const today0 = new Date(today.getFullYear(), today.getMonth(), today.getDate());

      if (d > today0){
        resEl.textContent = 'Date de permis dans le futur.';
        return;
      }

      const info = computePermitYearsRounded(d, today0);
      const crm = getCrmForYears(info.roundedYears);

      resEl.textContent = `CRM max : ${format2FR(crm)}`;
      detEl.textContent =
        `Permis : ${formatDateFR(d)} ; anciennet√© ‚âà ${info.wholeYears} an(s) + ${info.monthsInCurrentYear} mois` +
        ` ‚Üí retenu : ${info.roundedYears} an(s) (r√®gle des 9 mois).`;
    }

    /* ===== Reste de ton outil (frise / calculs) ===== */
    const GLUE_DAYS = 1;
    function toUtcNoonMs(date) { return Date.UTC(date.getFullYear(), date.getMonth(), date.getDate(), 12, 0, 0, 0); }
    function addDaysUtcNoon(date, days) {
      const t = toUtcNoonMs(date) + days * 24 * 60 * 60 * 1000;
      const d = new Date(t);
      return new Date(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate());
    }
    function addMonths(date, n) { const d = new Date(date.getTime()); d.setMonth(d.getMonth() + n); return d; }

    function extraMonthsFromRemainderDays(remDays) {
      if (!Number.isFinite(remDays) || remDays < 15) return 0;
      return Math.ceil((remDays - 14) / 30);
    }

    function intersectInterval(deb, fin, minDate, maxDate) {
      if (fin < minDate || deb > maxDate) return null;
      const start = deb < minDate ? minDate : deb;
      const end = fin > maxDate ? maxDate : fin;
      return { start, end };
    }

    function mergeIntervals(intervals) {
      if (intervals.length === 0) return [];
      intervals.sort((a, b) => a.start - b.start);
      const merged = [];
      let current = { start: new Date(intervals[0].start), end: new Date(intervals[0].end) };
      for (let i = 1; i < intervals.length; i++) {
        const next = intervals[i];
        const currentEndPlusGlue = addDaysUtcNoon(current.end, GLUE_DAYS);
        if (next.start <= currentEndPlusGlue) {
          if (next.end > current.end) current.end = new Date(next.end);
        } else {
          merged.push(current);
          current = { start: new Date(next.start), end: new Date(next.end) };
        }
      }
      merged.push(current);
      return merged;
    }

    function overlapsOrGlued(a, b) {
      const aEndPlus = addDaysUtcNoon(a.end, GLUE_DAYS);
      const bEndPlus = addDaysUtcNoon(b.end, GLUE_DAYS);
      return (a.start <= bEndPlus) && (b.start <= aEndPlus);
    }
    function isOverlapped(intervals, idx) {
      const a = intervals[idx];
      for (let j = 0; j < intervals.length; j++) {
        if (j === idx) continue;
        if (overlapsOrGlued(a, intervals[j])) return true;
      }
      return false;
    }

    function totalMonthsAcrossMerged(mergedIntervals) {
      let fullMonths = 0, remDaysTotal = 0;
      mergedIntervals.forEach(inter => {
        const r = monthsAndRemainderDays(inter.start, inter.end);
        fullMonths += r.months;
        remDaysTotal += r.remDays;
      });
      const extra = extraMonthsFromRemainderDays(remDaysTotal);
      return { fullMonths, remDaysTotal, extra, total: fullMonths + extra };
    }

    function computeGapsWithinWindow(windowStart, windowEnd, mergedIntervals) {
      const gaps = [];
      let cursor = new Date(windowStart);
      for (const inter of mergedIntervals) {
        if (inter.start > cursor) gaps.push({ start: new Date(cursor), end: new Date(inter.start) });
        if (inter.end > cursor) cursor = new Date(inter.end);
      }
      if (cursor < windowEnd) gaps.push({ start: new Date(cursor), end: new Date(windowEnd) });
      return gaps.filter(g => g.end > g.start);
    }
    function renderInterruptions(elId, gaps) {
      const el = document.getElementById(elId);
      if (!el) return;
      if (!gaps || gaps.length === 0) { el.innerHTML = `<div class="interruptionsTitle">Interruptions :</div>Aucune.`; return; }
      const lines = gaps.map(g => `- ${formatDateFR(g.start)} ‚Üí ${formatDateFR(g.end)}`);
      el.innerHTML = `<div class="interruptionsTitle">Interruptions :</div>${lines.join('\n')}`;
    }

    function clearCanvas(canvasId, legendId, message) {
      const canvas = document.getElementById(canvasId);
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      document.getElementById(legendId).textContent = message || '';
    }

    function placeTextAvoiding(ctx, text, x, levelDefs, placedRects, cssW, options) {
      const font = options.font || '11px Arial';
      const color = options.color || '#000';
      const pad = options.pad ?? 3;
      const approxH = options.h ?? 12;
      const preferredOrder = options.preferredOrder || [0,1,2,3];

      ctx.font = font;
      const w = ctx.measureText(text).width;

      for (const li of preferredOrder) {
        const lvl = levelDefs[li];
        const rect = {
          x: x - (w/2) - pad,
          y: (lvl.baseline === 'top') ? lvl.y : (lvl.y - approxH),
          w: w + 2*pad,
          h: approxH + 2
        };
        rect.x = Math.max(0, Math.min(cssW - rect.w, rect.x));

        let ok = true;
        for (const r of placedRects) {
          const overlap = !(rect.x > r.x + r.w || rect.x + rect.w < r.x || rect.y > r.y + r.h || rect.y + rect.h < r.y);
          if (overlap) { ok = false; break; }
        }
        if (!ok) continue;

        placedRects.push(rect);
        ctx.fillStyle = color;
        ctx.textAlign = 'center';
        ctx.textBaseline = lvl.baseline;
        const drawX = rect.x + rect.w / 2;
        ctx.fillText(text, drawX, lvl.y);
        return { placed: true, rect };
      }
      return { placed: false };
    }

    function getCssVar(name){
      return getComputedStyle(document.body).getPropertyValue(name).trim();
    }



// --- Canvas helpers (color alpha + rounded rect path) ---
function hexToRgb(hex){
  if(!hex) return null;
  let h = String(hex).trim();
  if(h.startsWith('#')) h = h.slice(1);
  if(h.length === 3) h = h.split('').map(ch => ch + ch).join('');
  if(h.length !== 6) return null;
  const r = parseInt(h.slice(0,2), 16);
  const g = parseInt(h.slice(2,4), 16);
  const b = parseInt(h.slice(4,6), 16);
  if(!Number.isFinite(r) || !Number.isFinite(g) || !Number.isFinite(b)) return null;
  return {r,g,b};
}

function colorWithAlpha(color, alpha){
  const c = String(color || '').trim();
  if(!c) return `rgba(0,0,0,${alpha})`;
  if(c.startsWith('rgba(')) return c;
  if(c.startsWith('rgb(')){
    const inside = c.slice(4, -1);
    return `rgba(${inside},${alpha})`;
  }
  const rgb = hexToRgb(c);
  if(rgb) return `rgba(${rgb.r},${rgb.g},${rgb.b},${alpha})`;
  return c;
}

function roundRectPath(ctx, x, y, w, h, r){
  const radius = Math.max(0, Math.min(r, Math.min(w, h) / 2));
  ctx.beginPath();
  ctx.moveTo(x + radius, y);
  ctx.arcTo(x + w, y, x + w, y + h, radius);
  ctx.arcTo(x + w, y + h, x, y + h, radius);
  ctx.arcTo(x, y + h, x, y, radius);
  ctx.arcTo(x, y, x + w, y, radius);
  ctx.closePath();
}
    function drawTimeline(canvasId, legendId, windowStart, windowEnd, mergedIntervals, label, crmMarkers){
  const canvas = document.getElementById(canvasId);
  const ctx = canvas.getContext('2d');

  const cssW = canvas.clientWidth || 420;
  const ratio = window.devicePixelRatio || 1;
  canvas.width  = Math.floor(cssW * ratio);
  canvas.height = Math.floor(136 * ratio);
  ctx.setTransform(ratio, 0, 0, ratio, 0, 0);

  const cssH = 136;
  ctx.clearRect(0, 0, cssW, cssH);

  const padL = 14, padR = 14;
  const yLine = 68;
  const lineW = cssW - padL - padR;

  const t0 = windowStart.getTime();
  const t1 = windowEnd.getTime();
  const span = Math.max(1, t1 - t0);

  function xOf(date){
    const t = date.getTime();
    const p = (t - t0) / span;
    return padL + Math.max(0, Math.min(1, p)) * lineW;
  }

  const isDark = document.body.classList.contains('dark');

  const red = getCssVar('--timelineRed');
  const green = getCssVar('--timelineGreen');
  const marker = getCssVar('--markerBlue');
  const softStroke = getCssVar('--softStroke') || (isDark ? 'rgba(255,255,255,0.16)' : 'rgba(17,24,39,0.12)');

  // Track (window) as a rounded pill, using the same red code but softened.
  const trackH = 18;
  const trackY = yLine - trackH/2;
  const trackX = padL;
  const trackW = lineW;
  const r = trackH/2;

  ctx.save();
  ctx.fillStyle = colorWithAlpha(red, isDark ? 0.28 : 0.18);
  roundRectPath(ctx, trackX, trackY, trackW, trackH, r);
  ctx.fill();

  // Subtle border like the rest of the UI.
  ctx.strokeStyle = softStroke;
  ctx.lineWidth = 1;
  roundRectPath(ctx, trackX + 0.5, trackY + 0.5, trackW - 1, trackH - 1, r);
  ctx.stroke();
  ctx.restore();

  // Covered periods (mergedIntervals) as rounded segments with a light shadow.
  mergedIntervals.forEach(inter => {
    const xs = xOf(inter.start);
    const xe = xOf(inter.end);
    if(xe <= xs) return;

    const segW = Math.max(2, xe - xs);
    const segH = trackH;
    const segY = trackY;

    ctx.save();
    ctx.shadowColor = isDark ? 'rgba(0,0,0,0.55)' : 'rgba(17,24,39,0.18)';
    ctx.shadowBlur = 10;
    ctx.shadowOffsetY = 2;

    const grad = ctx.createLinearGradient(xs, 0, xe, 0);
    grad.addColorStop(0, colorWithAlpha(green, isDark ? 0.95 : 0.92));
    grad.addColorStop(1, colorWithAlpha(green, isDark ? 0.80 : 0.86));

    ctx.fillStyle = grad;
    roundRectPath(ctx, xs, segY, segW, segH, r);
    ctx.fill();

    // Crisp edge
    ctx.shadowColor = 'transparent';
    ctx.strokeStyle = colorWithAlpha(green, isDark ? 0.55 : 0.45);
    ctx.lineWidth = 1;
    roundRectPath(ctx, xs + 0.5, segY + 0.5, segW - 1, segH - 1, r);
    ctx.stroke();

    ctx.restore();
  });

  // Bonus mois au centre (conserv√©)
  mergedIntervals.forEach(inter => {
    const xs = xOf(inter.start);
    const xe = xOf(inter.end);
    if(xe - xs < 22) return;

    const r0 = monthsAndRemainderDays(inter.start, inter.end);
    const months = r0.months + extraMonthsFromRemainderDays(r0.remDays);
    if(months <= 0) return;

    const mid = (xs + xe) / 2;
    const txt = String(months);

    ctx.save();
    ctx.font = '12px Arial';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';

    const stroke = getCssVar('--bonusTextStrokeDark');
    const fill = isDark ? getCssVar('--bonusTextDark') : getCssVar('--bonusText');

    if(isDark){
      ctx.lineWidth = 3;
      ctx.strokeStyle = stroke;
      ctx.strokeText(txt, mid, yLine);
    }
    ctx.fillStyle = fill;
    ctx.fillText(txt, mid, yLine);
    ctx.restore();
  });

  // Labels positioning helpers (keep collision-avoid logic)
  const placed = [];

  // Window start/end labels
  ctx.save();
  ctx.font = '12px Arial';
  const topY = 20;
  const padBlock = 6;
  const txtStart = formatDateFR(windowStart);
  const txtEnd = formatDateFR(windowEnd);
  const wStart = ctx.measureText(txtStart).width;
  const wEnd = ctx.measureText(txtEnd).width;
  placed.push({x: padL - padBlock, y: topY - 12, w: wStart + 2*padBlock, h: 16});
  placed.push({x: padL + lineW - wEnd - padBlock, y: topY - 12, w: wEnd + 2*padBlock, h: 16});

  const windowTextColor = isDark ? '#e8eaed' : '#111';
  ctx.fillStyle = windowTextColor;
  ctx.textBaseline = 'alphabetic';
  ctx.textAlign = 'left';
  ctx.fillText(txtStart, padL, topY);
  ctx.textAlign = 'right';
  ctx.fillText(txtEnd, padL + lineW, topY);
  ctx.restore();

  // Date labels
  const dateLevels = [
    {y: yLine + 22, baseline: 'top'},
    {y: yLine - 22, baseline: 'bottom'},
    {y: yLine + 36, baseline: 'top'},
    {y: yLine - 36, baseline: 'bottom'}
  ];

  const dateLabels = [];
  mergedIntervals.forEach(inter => {
    dateLabels.push({x: xOf(inter.start), text: formatDateFR(inter.start)});
    dateLabels.push({x: xOf(inter.end), text: formatDateFR(inter.end)});
  });
  dateLabels.sort((a,b) => a.x - b.x);

  ctx.save();
  dateLabels.forEach((lab, idx) => {
    if(idx > 0){
      const prev = dateLabels[idx - 1];
      if(lab.text === prev.text && Math.abs(lab.x - prev.x) < 2) return;
    }

    const preferredOrder = (idx % 2 === 0) ? [0,1,2,3] : [1,0,3,2];
    const res = placeTextAvoiding(ctx, lab.text, lab.x, dateLevels, placed, cssW, {
      font: '11px Arial',
      color: colorWithAlpha(green, isDark ? 0.70 : 0.78),
      preferredOrder,
      pad: 3,
      h: 12
    });
    if(!res.placed) return;

    ctx.save();
    ctx.strokeStyle = colorWithAlpha(green, isDark ? 0.55 : 0.55);
    ctx.lineWidth = 2;
    ctx.lineCap = 'round';
    ctx.beginPath();
    ctx.moveTo(lab.x, yLine - trackH/2 - 2);
    ctx.lineTo(lab.x, yLine + trackH/2 + 2);
    ctx.stroke();
    ctx.restore();
  });
  ctx.restore();

  // CRM markers
  const crmLevels = [
    {y: yLine - 44, baseline: 'bottom'},
    {y: yLine + 44, baseline: 'top'},
    {y: yLine - 58, baseline: 'bottom'},
    {y: yLine + 58, baseline: 'top'}
  ];

  if(Array.isArray(crmMarkers) && crmMarkers.length){
    ctx.save();
    crmMarkers.forEach((m, idx) => {
      const x = xOf(m.at);
      const pinTop = yLine - trackH/2 - 18;
      const pinBottom = yLine - trackH/2 - 2;

      ctx.strokeStyle = colorWithAlpha(marker, isDark ? 0.85 : 0.85);
      ctx.lineWidth = 2;
      ctx.lineCap = 'round';
      ctx.beginPath();
      ctx.moveTo(x, pinTop);
      ctx.lineTo(x, pinBottom);
      ctx.stroke();

      ctx.fillStyle = marker;
      ctx.beginPath();
      ctx.arc(x, pinTop, 3, 0, Math.PI * 2);
      ctx.fill();

      const preferredOrder = (idx % 2 === 0) ? [0,1,2,3] : [1,0,3,2];
      placeTextAvoiding(ctx, String(m.crm), x, crmLevels, placed, cssW, {
        font: '12px Arial',
        color: marker,
        preferredOrder,
        pad: 3,
        h: 12
      });
    });
    ctx.restore();
  }

  document.getElementById(legendId).textContent = `${label} (${formatDateFR(windowStart)} ‚Üí ${formatDateFR(windowEnd)})`;
}

function effacerTout() {
      document.getElementById('dateEffet').value = '';
for (let i = 1; i <= 20; i++) {
        document.getElementById('type' + i).value = 'AUTO';
        document.getElementById('deb' + i).value = '';
        document.getElementById('fin' + i).value = '';
        document.getElementById('crm' + i).value = '';
        document.getElementById('mois' + i).textContent = '';
      }

      document.getElementById('totalMois').textContent = '';
      document.getElementById('interruptionTxt').textContent = '';
      document.getElementById('errors').textContent = '';

      document.getElementById('debIndep').value = '';
      document.getElementById('finIndep').value = '';
      document.getElementById('resultIndep').textContent = '';

      document.getElementById('dateEnvoiHamon').value = '';
      document.getElementById('resultHamon').textContent = '';

      document.getElementById('notes').value = '';

      document.getElementById('cardMoto').style.display = 'none';

      clearCanvas('canvasAuto', 'legendAuto', 'Renseigne une date d‚Äôeffet pour afficher la frise.');
      clearCanvas('canvasMoto', 'legendMoto', '');

      document.getElementById('interruptionsAuto').textContent = '';
      document.getElementById('interruptionsMoto').textContent = '';

      document.getElementById('crmToolInput').value = '';
      document.getElementById('crmToolResult').textContent = '';
      document.getElementById('crmToolTrail').textContent = '';
      crmBaseValue = null;
      crmCurrentValue = null;
      crmClicks = [];

      document.getElementById('permitDate').value = '';
      document.getElementById('permitCrmResult').textContent = '';
      document.getElementById('permitCrmDetail').textContent = '';

      hideTooltip();
        // Reset Moto (d√©s√©lection + arr√™t du glow)
  const motoCb = document.getElementById('moto');
  if (motoCb) motoCb.checked = false;
  if (typeof syncMotoBtn === 'function') syncMotoBtn();

calculer(); calculIndep(); calculHamon();
    }

    function calculIndep() {
      const out = document.getElementById('resultIndep');
      const deb = parseDateFlexible(document.getElementById('debIndep').value);
      const fin = parseDateFlexible(document.getElementById('finIndep').value);

      out.textContent = '';

      const rawDeb = String(document.getElementById('debIndep').value || '').trim();
      const rawFin = String(document.getElementById('finIndep').value || '').trim();
      if (!rawDeb && !rawFin) return;

      if (!deb || !fin) {
        out.textContent = 'Dates invalides.';
        return;
      }
      if (fin < deb) {
        out.textContent = 'Date fin ant√©rieure √† date d√©but.';
        return;
      }

      const r = monthsAndRemainderDays(deb, fin);
      const years = Math.floor(r.months / 12);
      const months = r.months % 12;
      const days = r.remDays;

      const parts = [];
      if (years) parts.push(`${years} an(s)`);
      if (months) parts.push(`${months} mois`);
      if (days || parts.length === 0) parts.push(`${days} jour(s)`);

      out.textContent = `${parts.join(' et ')}
${formatDateFR(deb)} ‚Üí ${formatDateFR(fin)}`;
    }

    function calculHamon() {
      const out = document.getElementById('resultHamon');
      const d = parseDateFlexible(document.getElementById('dateEnvoiHamon').value);
      out.textContent = '';
      if (!d) {
        if (String(document.getElementById('dateEnvoiHamon').value || '').trim() === '') return;
        out.textContent = 'Date invalide.';
        return;
      }
      const eff = addDaysUtcNoon(d, 33);
      out.textContent = `Effet : ${formatDateFR(eff)}`;
    }

    function calculer() {
      const errorsEl = document.getElementById('errors');
      const totalEl = document.getElementById('totalMois');
      const interrupEl = document.getElementById('interruptionTxt');

      errorsEl.textContent = '';
      totalEl.textContent = '';
      interrupEl.textContent = '';

      for (let i = 1; i <= 20; i++) document.getElementById('mois' + i).textContent = '';

      const dEffet = parseDateFlexible(document.getElementById('dateEffet').value);
      const motoChecked = document.getElementById('moto').checked;

      const refMonths = motoChecked ? 24 : 36;
      document.getElementById('cardMoto').style.display = motoChecked ? 'block' : 'none';

      let win = null;
      if (dEffet) {
        const end = new Date(dEffet.getFullYear(), dEffet.getMonth(), dEffet.getDate());
        win = { start: addMonths(end, -refMonths), end };
      }

      const lineIntervalsAuto = [];
      const lineIntervalsMoto = [];
      const intervalsAuto = [];
      const intervalsMoto = [];
      let hasError = false;

      for (let i = 1; i <= 20; i++) {
        const type = document.getElementById('type' + i).value;
        const debStr = document.getElementById('deb' + i).value.trim();
        const finStr = document.getElementById('fin' + i).value.trim();
        const crmStr = document.getElementById('crm' + i).value.trim();

        if (!debStr && !finStr && !crmStr) continue;

        const deb = parseDateFlexible(debStr);
        const fin = parseDateFlexible(finStr);

        if (!deb || !fin || fin < deb) {
          document.getElementById('mois' + i).textContent = 'Erreur';
          hasError = true;
          continue;
        }

        let inter = { start: deb, end: fin, line: i, crm: crmStr };

        if (win) {
          const clipped = intersectInterval(deb, fin, win.start, win.end);
          if (!clipped) { document.getElementById('mois' + i).textContent = '0'; continue; }
          inter = { start: clipped.start, end: clipped.end, line: i, crm: crmStr };
        }

        const rLine = monthsAndRemainderDays(inter.start, inter.end);
        document.getElementById('mois' + i).textContent = String(rLine.months + extraMonthsFromRemainderDays(rLine.remDays));

        if (type === 'AUTO') { intervalsAuto.push({ start: inter.start, end: inter.end }); lineIntervalsAuto.push(inter); }
        else { intervalsMoto.push({ start: inter.start, end: inter.end }); lineIntervalsMoto.push(inter); }
      }

      if (hasError) errorsEl.textContent = 'Erreurs d√©tect√©es dans certaines lignes (dates invalides ou invers√©es).';

      const mergedAuto = mergeIntervals(intervalsAuto);
      const mergedMoto = mergeIntervals(intervalsMoto);

      const autoAgg = totalMonthsAcrossMerged(mergedAuto);
      const motoAgg = totalMonthsAcrossMerged(mergedMoto);

      if (!dEffet) {
        clearCanvas('canvasAuto', 'legendAuto', 'Renseigne une date d‚Äôeffet pour afficher la frise.');
        clearCanvas('canvasMoto', 'legendMoto', '');
        renderInterruptions('interruptionsAuto', []);
        renderInterruptions('interruptionsMoto', []);
        totalEl.textContent = motoChecked
          ? `Ant√©c√©dents (sans restriction) : Auto = ${autoAgg.total} mois ; Moto = ${motoAgg.total} mois.`
          : `Ant√©c√©dents (sans restriction) : Auto = ${autoAgg.total} mois.`;
        interrupEl.textContent = `Interruption : n√©cessite une date d‚Äôeffet (${refMonths} mois).`;
        return;
      }

      function buildCrmMarkers(lineIntervals) {
        const intervalsOnly = lineIntervals.map(x => ({ start: x.start, end: x.end }));
        const markers = [];
        for (let idx = 0; idx < lineIntervals.length; idx++) {
          const li = lineIntervals[idx];
          if (!li.crm) continue;
          if (isOverlapped(intervalsOnly, idx)) continue;
          markers.push({ at: li.end, crm: li.crm });
        }
        markers.sort((a, b) => a.at - b.at);
        return markers;
      }

      drawTimeline('canvasAuto', 'legendAuto', win.start, win.end, mergedAuto, `AUTO (${refMonths} mois)`, buildCrmMarkers(lineIntervalsAuto));
      if (motoChecked) drawTimeline('canvasMoto', 'legendMoto', win.start, win.end, mergedMoto, `MOTO (${refMonths} mois)`, buildCrmMarkers(lineIntervalsMoto));
      else clearCanvas('canvasMoto', 'legendMoto', '');

      renderInterruptions('interruptionsAuto', computeGapsWithinWindow(win.start, win.end, mergedAuto));
      if (motoChecked) renderInterruptions('interruptionsMoto', computeGapsWithinWindow(win.start, win.end, mergedMoto));
      else document.getElementById('interruptionsMoto').textContent = '';

      const interAuto = Math.max(0, refMonths - autoAgg.total);
      if (motoChecked) {
        const interMoto = Math.max(0, refMonths - motoAgg.total);
        totalEl.textContent = `Ant√©c√©dents : Auto = ${autoAgg.total} mois ; Moto = ${motoAgg.total} mois.`;
        interrupEl.textContent = `Interruption estim√©e : Auto = ${interAuto} mois ; Moto = ${interMoto} mois.`;
      } else {
        totalEl.textContent = `Ant√©c√©dents : Auto = ${autoAgg.total} mois.`;
        interrupEl.textContent = `Interruption estim√©e : ${interAuto} mois (${refMonths} - ${autoAgg.total}).`;
      }
    }

    function initCanvases(){
      clearCanvas('canvasAuto', 'legendAuto', 'Renseigne une date d‚Äôeffet pour afficher la frise.');
      clearCanvas('canvasMoto', 'legendMoto', '');
      renderInterruptions('interruptionsAuto', []);
      renderInterruptions('interruptionsMoto', []);
    }

    /* ===== Tooltip Indicatif frise ===== */
    function showTooltipAt(x, y, html){
      const tip = document.getElementById('crmTooltip');
      tip.innerHTML = html;
      tip.style.display = 'block';

      const pad = 10;
      const rect = tip.getBoundingClientRect();
      let left = x + 12;
      let top = y + 12;

      const maxLeft = window.innerWidth - rect.width - pad;
      const maxTop = window.innerHeight - rect.height - pad;

      left = Math.max(pad, Math.min(maxLeft, left));
      top = Math.max(pad, Math.min(maxTop, top));

      tip.style.left = left + 'px';
      tip.style.top = top + 'px';
    }
    function hideTooltip(){
      const tip = document.getElementById('crmTooltip');
      tip.style.display = 'none';
      tip.innerHTML = '';
    }

    /* ===== Listeners ===== */
    document.getElementById('btnTheme').addEventListener('click', toggleTheme);
    document.getElementById('btnCrmTable').addEventListener('click', toggleCrmTable);
    document.getElementById('btnCrmTool').addEventListener('click', toggleCrmTool);
    document.getElementById('btnCrmPermit').addEventListener('click', toggleCrmPermit);
    document.getElementById('btnClear').addEventListener('click', effacerTout);
    document.getElementById('btnMeta').addEventListener('click', toggleMeta);

    document.getElementById('crmToolInput').addEventListener('focus', () => resetCrmToolState());
    document.getElementById('crmToolInput').addEventListener('input', () => { resetCrmToolState(); updateCrmToolUI(); });

    document.getElementById('btnCrmNone').addEventListener('click', () => applyCrmAction(CRM_ACTIONS[0]));
    document.getElementById('btnCrm50').addEventListener('click', () => applyCrmAction(CRM_ACTIONS[1]));
    document.getElementById('btnCrm100').addEventListener('click', () => applyCrmAction(CRM_ACTIONS[2]));

    document.getElementById('permitDate').addEventListener('input', updatePermitCrm);

    document.getElementById('crmInfoBtn').addEventListener('click', (e) => {
      const msg =
        `<strong>Indicatif frise</strong><br>` +
        `<em>Champ indicatif : sert uniquement √† afficher un rep√®re (CRM) sur la frise.</em>`;
      showTooltipAt(e.clientX, e.clientY, msg);
    });

    document.addEventListener('click', (e) => {
      const tip = document.getElementById('crmTooltip');
      if (tip.style.display === 'block') {
        const btn = document.getElementById('crmInfoBtn');
        if (tip.contains(e.target) || btn.contains(e.target)) return;
        hideTooltip();
      }
    });
    window.addEventListener('scroll', hideTooltip, { passive: true });
    window.addEventListener('resize', hideTooltip);

    document.querySelectorAll('input[type="text"], input[type="checkbox"], select').forEach(el => {
      el.addEventListener('input', calculer);
      el.addEventListener('change', calculer);
    });
    document.getElementById('debIndep').addEventListener('input', calculIndep);
    document.getElementById('finIndep').addEventListener('input', calculIndep);
    document.getElementById('dateEnvoiHamon').addEventListener('input', calculHamon);

    document.addEventListener('DOMContentLoaded', () => {
      initTheme();
      renderMetaVersion();
      checkForUpdate();
      initCanvases();
      initAutoFormatAllDateInputs();
      calculer(); calculIndep(); calculHamon();
      updateCrmToolUI();
      updatePermitCrm();
    });
  

// --- UI enhancement: toggle switch Auto<->Moto for each type select (keeps calculations unchanged) ---
function syncTypeToggles(){
  document.querySelectorAll('.typeSwitchToggle').forEach(sw => {
    const targetId = sw.getAttribute('data-target');
    const sel = document.getElementById(targetId);
    if(!sel) return;
    const isMoto = (sel.value === 'MOTO');
    sw.classList.toggle('isMoto', isMoto);
    sw.setAttribute('aria-checked', isMoto ? 'true' : 'false');
  });
}

function toggleTypeSwitch(sw){
  const targetId = sw.getAttribute('data-target');
  const sel = document.getElementById(targetId);
  if(!sel) return;
  const next = (sel.value === 'MOTO') ? 'AUTO' : 'MOTO';
  sel.value = next;
  sel.dispatchEvent(new Event('change', { bubbles: true }));
  syncTypeToggles();
}

function initTypeToggles(){
  document.querySelectorAll('.typeSwitchToggle').forEach(sw => {
    sw.addEventListener('click', (e) => {
      e.preventDefault();
      toggleTypeSwitch(sw);
    });
    sw.addEventListener('keydown', (e) => {
      if(e.key === ' ' || e.key === 'Enter'){
        e.preventDefault();
        toggleTypeSwitch(sw);
      }
    });
  });

  // Keep toggles in sync after reset
  const clearBtn = document.getElementById('btnClear');
  if(clearBtn){
    clearBtn.addEventListener('click', () => setTimeout(syncTypeToggles, 0));
  }
}

document.addEventListener('DOMContentLoaded', () => {
  initTypeToggles();
  syncTypeToggles();
});


// --- UI enhancement: Moto tool button (keeps #moto checkbox for logic) ---
function syncMotoBtn(){
  const cb = document.getElementById('moto');
  const btn = document.getElementById('btnMoto');
  if(!cb || !btn) return;
  const on = !!cb.checked;
  btn.classList.toggle('toolBtnActive', on);
  btn.setAttribute('aria-pressed', on ? 'true' : 'false');
}

function initMotoBtn(){
  const cb = document.getElementById('moto');
  const btn = document.getElementById('btnMoto');
  if(!cb || !btn) return;

  btn.addEventListener('click', () => {
    cb.checked = !cb.checked;
    cb.dispatchEvent(new Event('input', { bubbles: true }));
    cb.dispatchEvent(new Event('change', { bubbles: true }));
    syncMotoBtn();
  });

  cb.addEventListener('change', syncMotoBtn);
  syncMotoBtn();
}

document.addEventListener('DOMContentLoaded', initMotoBtn);


// --- Collapsible panels: Independent & Hamon (1 seul ouvert) ---
function setPanelOpen(cardId, btnId, isOpen){
  const card = document.getElementById(cardId);
  const btn  = document.getElementById(btnId);
  if(!card || !btn) return;
  card.style.display = isOpen ? 'block' : 'none';
  btn.classList.toggle('toolBtnActive', !!isOpen);
}

function toggleExclusive(btnId, cardId, otherBtnId, otherCardId){
  const card = document.getElementById(cardId);
  if(!card) return;

  const isOpen = (card.style.display === 'block');
  const willOpen = !isOpen;

  // Si on ouvre, on ferme l'autre.
  if(willOpen) setPanelOpen(otherCardId, otherBtnId, false);

  setPanelOpen(cardId, btnId, willOpen);
}

document.addEventListener('DOMContentLoaded', () => {
  const b1 = document.getElementById('btnToggleIndep');
  if(b1) b1.addEventListener('click', () => toggleExclusive('btnToggleIndep','indepCard','btnToggleHamon','hamonCard'));

  const b2 = document.getElementById('btnToggleHamon');
  if(b2) b2.addEventListener('click', () => toggleExclusive('btnToggleHamon','hamonCard','btnToggleIndep','indepCard'));
});

// --- Autosave / restore form fields (prevents loss on refresh) ---
const AUTOSAVE_KEY = 'outilValidation_autosave_v024';

function getFieldValue(el){
  const tag = (el.tagName || '').toLowerCase();
  const type = (el.getAttribute('type') || '').toLowerCase();
  if(tag === 'input' && (type === 'checkbox' || type === 'radio')) return !!el.checked;
  return String(el.value ?? '');
}

function setFieldValue(el, val){
  const tag = (el.tagName || '').toLowerCase();
  const type = (el.getAttribute('type') || '').toLowerCase();
  if(tag === 'input' && (type === 'checkbox' || type === 'radio')){
    el.checked = !!val;
  }else{
    el.value = (val ?? '');
  }
}

function listSavableFields(){
  // Only elements with an id (stable key)
  const selectors = [
    'input[id]',
    'select[id]',
    'textarea[id]'
  ].join(',');
  const all = Array.from(document.querySelectorAll(selectors));
  // Exclude buttons and hidden helper fields if ever present
  return all.filter(el => {
    const tag = (el.tagName||'').toLowerCase();
    if(tag === 'input'){
      const t = (el.getAttribute('type')||'text').toLowerCase();
      if(t === 'button' || t === 'submit' || t === 'reset') return false;
    }
    return true;
  });
}

function buildSavePayload(){
  const payload = { ts: Date.now(), fields: {} };
  listSavableFields().forEach(el => {
    const id = el.id;
    if(!id) return;
    payload.fields[id] = { v: getFieldValue(el) };
  });

  // Save a few UI states that matter for user (optional)
  const indep = document.getElementById('indepCard');
  const hamon = document.getElementById('hamonCard');
  if(indep) payload.fields.__indepOpen = { v: (indep.style.display === 'block') };
  if(hamon) payload.fields.__hamonOpen = { v: (hamon.style.display === 'block') };

  return payload;
}

function saveAllFields(){
  try{
    const payload = buildSavePayload();
    localStorage.setItem(AUTOSAVE_KEY, JSON.stringify(payload));
  }catch(e){
    // Storage may be blocked; ignore
  }
}

function restoreAllFields(){
  let raw = null;
  try{ raw = localStorage.getItem(AUTOSAVE_KEY); }catch(e){ return; }
  if(!raw) return;

  let payload = null;
  try{ payload = JSON.parse(raw); }catch(e){ return; }
  if(!payload || !payload.fields) return;

  // Restore regular fields
  Object.keys(payload.fields).forEach(id => {
    if(id.startsWith('__')) return;
    const el = document.getElementById(id);
    if(!el) return;
    setFieldValue(el, payload.fields[id].v);
    // Trigger existing logic (calculs, UI)
    el.dispatchEvent(new Event('input', { bubbles: true }));
    el.dispatchEvent(new Event('change', { bubbles: true }));
  });

  // Restore collapsible states if present
  const indep = document.getElementById('indepCard');
  const hamon = document.getElementById('hamonCard');
  if(indep && payload.fields.__indepOpen) indep.style.display = payload.fields.__indepOpen.v ? 'block' : 'none';
  if(hamon && payload.fields.__hamonOpen) hamon.style.display = payload.fields.__hamonOpen.v ? 'block' : 'none';

  // Sync button states if your toggle logic uses classes
  const bIndep = document.getElementById('btnToggleIndep');
  if(bIndep && indep) bIndep.classList.toggle('toolBtnActive', indep.style.display === 'block');
  const bHamon = document.getElementById('btnToggleHamon');
  if(bHamon && hamon) bHamon.classList.toggle('toolBtnActive', hamon.style.display === 'block');

  // Moto UI sync if function exists
  if(typeof syncMotoBtn === 'function') syncMotoBtn();
}

function installAutosave(){
  let t = null;
  const schedule = () => {
    clearTimeout(t);
    t = setTimeout(saveAllFields, 250);
  };
  listSavableFields().forEach(el => {
    el.addEventListener('input', schedule);
    el.addEventListener('change', schedule);
  });

  // If user clicks Effacer, also clear autosave
  const clearBtn = document.getElementById('btnClear');
  if(clearBtn){
    clearBtn.addEventListener('click', () => {
      try{ localStorage.removeItem(AUTOSAVE_KEY); }catch(e){}
    });
  }
}

// --- Update UX: in-page refresh when a new version is available ---
function reloadWithBust(versionTag){
  // Works when served over http(s). For file://, reloading won't fetch a newer HTML.
  if(!(location.protocol === 'http:' || location.protocol === 'https:')) return;
  saveAllFields();
  const url = new URL(window.location.href);
  if(versionTag) url.searchParams.set('v', String(versionTag));
  url.searchParams.set('ts', String(Date.now()));
  window.location.replace(url.toString());
}

function wireUpdateNow(remoteVersion){
  const btn = document.getElementById('btnUpdateNow');
  if(!btn) return;
  btn.onclick = () => reloadWithBust(remoteVersion);
}

// --- Optional: check for update periodically so banner can appear even if page stays open ---
function startPeriodicUpdateCheck(){
  if(typeof checkForUpdate !== 'function') return;
  setInterval(checkForUpdate, 10 * 60 * 1000); // every 10 min
}

// --- Optional: daily refresh at 08:00 (local time) to reduce outdated clients ---
function ymdLocal(d){
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const da = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${da}`;
}

function msUntilNextLocal(hour, minute){
  const now = new Date();
  const next = new Date(now);
  next.setHours(hour, minute, 0, 0);
  if(next <= now) next.setDate(next.getDate() + 1);
  return next - now;
}

function scheduleDailyRefreshAt0800(){
  if(!(location.protocol === 'http:' || location.protocol === 'https:')) return;
  const delay = msUntilNextLocal(8, 0) + Math.floor(Math.random() * 30000); // jitter 0-30s
  setTimeout(() => {
    try{
      const key = 'dailyRefreshDone';
      const today = ymdLocal(new Date());
      if(localStorage.getItem(key) !== today){
        localStorage.setItem(key, today);
        reloadWithBust(today);
        return;
      }
    }catch(e){}
    scheduleDailyRefreshAt0800();
  }, delay);
}

document.addEventListener('DOMContentLoaded', () => {
  restoreAllFields();
  installAutosave();
  startPeriodicUpdateCheck();
  scheduleDailyRefreshAt0800();
});


function copyNotesToClipboard(){
  const ta = document.getElementById('notes');
  const btn = document.getElementById('btnCopyNotes');
  if(!ta) return;
  const text = String(ta.value ?? '');

  const feedback = (ok) => {
    if(!btn) return;
    const old = btn.title;
    btn.title = ok ? 'Copi√© !' : 'Copie impossible';
    setTimeout(()=>{ btn.title = old; }, 900);
  };

  const fallback = () => {
    try{
      const tmp = document.createElement('textarea');
      tmp.value = text;
      tmp.setAttribute('readonly','');
      tmp.style.position = 'fixed';
      tmp.style.top = '-1000px';
      tmp.style.left = '-1000px';
      document.body.appendChild(tmp);
      tmp.select();
      tmp.setSelectionRange(0, tmp.value.length);
      const ok = document.execCommand && document.execCommand('copy');
      document.body.removeChild(tmp);
      feedback(!!ok);
    }catch(e){
      feedback(false);
    }
  };

  if(navigator.clipboard && window.isSecureContext){
    navigator.clipboard.writeText(text).then(()=>feedback(true)).catch(()=>fallback());
  }else{
    fallback();
  }
}

</script>
</body>
</html>
